<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>📷🎤 ESP32 雙向語音 + MJPEG 串流</title>
  <style>
    body { font-family: sans-serif; background: #111; color: #eee; text-align: center; }
    img { width: 100%; max-width: 640px; border-radius: 10px; background: #000; }
    button { padding: 10px 16px; margin: 10px; font-size: 16px; border-radius: 8px; }
    .status { margin: 10px 0; color: #6f6; }
  </style>
</head>
<body>
  <h2>🎥 MJPEG 串流 + 🎤 雙向語音</h2>
  <img id="cam" src="http://192.168.0.78:80/stream" alt="Camera Stream" />
  <div>
    <button onclick="startMic()">🎙️ 開始傳送語音</button>
    <button onclick="stopMic()">🛑 停止語音</button>
  </div>
  <div class="status" id="status">等待連線中...</div>

  <script>
    const statusEl = document.getElementById("status");
    const wsOut = new WebSocket("wss://esp32-server-st33.onrender.com/fromESP");
    const wsIn  = new WebSocket("wss://esp32-server-st33.onrender.com/toESP");

    let audioCtx;
    let workletNode;
    let micStream;

    // 🎧 播放 ESP32 傳來的音訊
    wsOut.binaryType = "arraybuffer";
    wsOut.onmessage = async (event) => {
      if (!audioCtx) {
        audioCtx = new AudioContext();
        await audioCtx.audioWorklet.addModule("worklet.js");
        workletNode = new AudioWorkletNode(audioCtx, "pcm-player");
        workletNode.connect(audioCtx.destination);
      }
      const pcm = new Int16Array(event.data);
      workletNode.port.postMessage(pcm);
    };

    // 🎙️ 錄音並傳送音訊到 ESP32
    async function startMic() {
      statusEl.innerText = "🎙️ 錄音中...";
      micStream = await navigator.mediaDevices.getUserMedia({ audio: true });
      audioCtx = new AudioContext();
      const source = audioCtx.createMediaStreamSource(micStream);
      const processor = audioCtx.createScriptProcessor(1024, 1, 1);
      processor.onaudioprocess = (e) => {
        const input = e.inputBuffer.getChannelData(0);
        const pcm = new Int16Array(input.length);
        for (let i = 0; i < input.length; i++) {
          let s = input[i] * 32767;
          pcm[i] = Math.max(-32768, Math.min(32767, s));
        }
        if (wsIn.readyState === WebSocket.OPEN) {
          wsIn.send(pcm);
        }
      };
      source.connect(processor);
      processor.connect(audioCtx.destination);
    }

    function stopMic() {
      statusEl.innerText = "🛑 麥克風關閉";
      if (micStream) micStream.getTracks().forEach(t => t.stop());
    }

    wsOut.onopen = () => statusEl.innerText = "✅ 影像與語音連線成功";
    wsOut.onerror = () => statusEl.innerText = "❌ 語音接收錯誤";
    wsIn.onerror = () => statusEl.innerText = "❌ 語音傳送錯誤";
  </script>
</body>
</html>
